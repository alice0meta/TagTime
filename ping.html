<!DOCTYPE html>
<html><head>
	<meta charset="utf-8">
<style>
	/* behavior */
	body {margin:8px;  white-space:nowrap;}
	body {-webkit-app-region:drag;} .expando_input, button {-webkit-app-region:no-drag;}
	#body {display:inline-block;}
	
	/* element defn */
	.expando_input {display:table-cell;}

	/* style */
	* {outline:none;}
	body {background-color:#222; color:#fff; font-family:Monaco,monospace; font-size:12px;}
	p {margin:0;}
	button {background-color:#333; border:1px solid #666; cursor:pointer; padding:2px 4px; color:inherit; font:inherit;}
	button.inline {margin:-1px -3px; padding:0 2px;}
	.tag_editor {margin:5px;} ol.tag_editor {padding:0; list-style:none;}
	.tags_in_li {display:inline-block; vertical-align:bottom; margin:0 0 0 1ch;}
	.key {background-color:#333; border:1px solid #666; padding:0 0.5ch 0 0.4ch; border-radius:0.5ch;}
	.curr_line {background-color:#444;} li.curr_line {margin:0 -13px; padding:0 13px;}
	.tagstr, .tags_in {color:#ffd700;}
	.time {color:#08f;}
	.emphasis {background-color:#800; margin:0 -0.5ch; padding:0 0.5ch;} /*//! maybe ... <em>?*/
</style></head>
<body><div id='body'></div></body></html>
<script>

var gui = require('nw.gui')
var m = require('moment')
var win = gui.Window.get()
var t = require('jquery'); var $ = function(v){return t(v,document)}; $.__proto__ = t; $.prototype = t.prototype
var exec = require('child_process').exec
var util = require('util')
var _ = require('underscore')

var A = function(v){return Array.prototype.slice.call(v)}
$.prototype.focus_end = function(){this.focus(); try {var t = document.createRange(); t.selectNodeContents(this[0]); t.collapse(false); var u = window.getSelection(); u.removeAllRanges(); u.addRange(t)} catch (e) {print('nonfatal error',e)}; return this}
$.prototype.on_key = function(key,cb0){
	var t = {'⇥':[9,'↓'],'↩':[13],'⎋':[27,'↑'],'←':[37,'↓'],'↑':[38,'↓'],'→':[39,'↓'],'↓':[40,'↓']}
	var keyc = t[key]? t[key][0] : (typeof(key)==='number'? key : key.charCodeAt(0))
	this.on(((t[key]?{'↑':'keyup','↓':'keydown'}[t[key][1]]:0)||'keypress')+(key==='⎋'?'':'.qqq'),function(e){if (e.which===keyc) return cb0(e)}) }
var now = function(){return new Date()/1000}
win.showf = function(){win.show(); win.focus()}
Array.prototype.zipmap = function(f,ctx){return _.zip.apply(_,this).map(function(v){return f.apply(ctx,v)})}

//! copied
var print = function(){var a = A(arguments)
	process.stdout.write(a.map(function(v){return typeof(v)==='string'? v : util.inspect(v,{colors:true,depth:2})}).join(' ')+'\n')
	if (typeof(window)!=='undefined') window.__ = a
	return a[-1]}
Function.prototype.in = function(time){var args = Array.prototype.slice.call(arguments).slice(1); return !time || time<=0? (setImmediate||setTimeout).apply(null,[this].concat(args)) : setTimeout.apply(null,[this,time*1000].concat(args))}
Function.prototype.at = function(time){arguments[0] -= now(); return this.in.apply(this,arguments)}
Function.prototype.every = function(time){var args = Array.prototype.slice.call(arguments).slice(1); return setInterval.apply(null,[this].concat(args))}
Function.prototype.def = function(m,get,set){Object.defineProperty(this.prototype,m,{configurable:true, enumerable:false, get:get, set:set}); return this}
;[Array,String].forEach(function(Class){_.range(0,5).forEach(function(i){Class.def('-'+i,function(){return this.length<i? undefined : this[this.length-i]},function(v){return this.length<i? v : this[this.length-i] = v})})})
var tags_split = function(v){return v.trim().split(/ +/)}
var tags_union = function(a,b){return _.union(tags_split(a),tags_split(b)).join(' ').trim()}

var future    = function(v){return v.time > now()}
var late      = function(v){return Math.abs(now()-v.time) > 20}
var very_late = function(v){return Math.abs(now()-v.time) > 86400/3}

var args
var prev_ping
var pings = []
var shown; var done

//! this file is a monstrous mess
//! can we unify ping object tags and element tags?

var build_window = function(){
	var L = function(a,b){a = 'IDS_'+a+'_MAC'; return b? nwDispatcher.getNSStringFWithFixup(a,b) : nwDispatcher.getNSStringWithFixup(a)}
	var menu = function(args,v){var r = args? new gui.Menu(args) : new gui.Menu(); v.forEach(function(v){
		var t = {label:v[0]}
		if (v[1]) {t.modifiers = v[1].split('').slice(0,-1).map(function(v){return v.replace(/⌘/g,'cmd').replace(/⇧/g,'shift').replace(/⌥/g,'alt').replace(/\^/g,'ctrl')}).join('-'); t.key = v[1][-1]}
		if (typeof(v[2])==='string') t.selector = v[2]
		else if (typeof(v[2])==='function') {t.click = v[2]; if ({'⎋':1}[v[1]]) $(window).on_key(v[1],t.click)}
		else t.submenu = v[2]
		r.append(new gui.MenuItem(t))
	}); return r}

	win.menu = menu({type:'menubar'},[
		['',0,menu(0,[
			['Cancel','⎋',function(){win.close()}],
			['Cancel','⌘w','performClose:'],
			['Cancel','⌘q','performClose:'],
			['DevTools','⌘⌥i',function(){win.isDevToolsOpen()? win.closeDevTools() : win.showDevTools()}],
			['DevTools','⌘;',function(){win.isDevToolsOpen()? win.closeDevTools() : win.showDevTools()}],
			])],
		[L('EDIT_MENU'),0,menu(0,[
			[L('EDIT_UNDO'), '⌘z', 'undo:'],
			[L('EDIT_REDO'), '⌘⇧z', 'redo:'],
			[L('CUT'), '⌘x', 'cut:'],
			[L('COPY'), '⌘c', 'copy:'],
			[L('PASTE'), '⌘v', 'paste:'],
			[L('EDIT_SELECT_ALL'), '⌘a', 'selectAll:'],
			])],
		])

	win.on('close',function(){try {return_and_close(true)} catch (e) {win.close(true); args.cb(e); throw e}})

	$(window).mouseenter(win.showf)

	var macros = function λ(){return typeof(args.macros)==='string'? λ._ && λ.stale > now() - 5? λ._ : (λ.stale=now(),λ._=JSON.parse(global.fs(args.macros).$)) : args.macros}
	if (args.macros) (function(){if (shown && $('.tags_in').length>0) {var m = macros(); $('.tags_in').map(function(i,v){var t=$(v).text(); if (t=t.match(/^(.*?)(\S+) $/)) $(v).text(t[1]+(m[t[2]]||t[2])+' ')})}}).every(0.2)
	}

var fetch_up = function(cb){if (pings.length>0 && prev_ping===undefined && args.ping_before) args.ping_before(pings[0].time,function(ping){prev_ping = ping||null; cb&&cb()}); else cb&&cb()}

var regenerate = function(cb){if (shown){
	var S = function(c){return $('<span class="'+c+'">')}
	var Key = function(v){return S('key').html(v)}
	var Expando_input = function(co,ci){return $('<div class="'+co+'"><div class="expando_input '+ci+'" contenteditable="true"></div></div>')}

	if (!$('#body').is(':empty')) {
		$('#body').html('')
		$(window).off('.qqq')
	}

	if (pings.length===1) {
		var v = pings[0]
		$('#body').html([
			$('<p>').html(["It's tag time! What ",late(v)? S('emphasis').html(future(v)?'are':'were') : 'are',' you doing RIGHT ',late(v)?'AT':'NOW',' ',S('time').html(m(v.time*1000).format((very_late(v)?'YYYY-MM-DD/':'')+'HH:mm:ss')),'?']),
			prev_ping? $('<p>').html([Key("'"),' to repeat previous tags: ',$('<button id="ditto" class="inline tagstr">').text(prev_ping.tags)]) : '',
			Expando_input('tag_editor','tags_in'),
		])

		$('.tags_in').focus_end()
		$(window).on('click.qqq',function(e){$('.tags_in').focus_end()})
		$('.tags_in').on('click.qqq',function(e){e.stopPropagation()})

		$('.tags_in').on_key('↩',function(e){if ($('.tags_in').text()!=='') return_and_close(); return false})
		if (prev_ping) {
			var ditto = function(){$('.tags_in').text(tags_union($('.tags_in').text(),prev_ping.tags)); return_and_close()}
			$('#ditto').on('click.qqq',ditto)
			$(window).on_key("'",function(e){e.preventDefault(); ditto()})
			}
		$(window).on_key('⇥',function(e){return false})
		$(window).on_key('↑',function(e){pings.unshift(prev_ping); prev_ping = undefined; fetch_up(regenerate)})

		var x; var y; win.setResizable(true); win.resizeTo(x=$('#body').width()+16,y=$('#body').height()+16); win.setResizable(false)
		win.moveTo(Math.round((window.screen.width-x)/2),Math.round((window.screen.height-y)/2))
	} else if (pings.length > 200 && confirm("oh dear, we're about to try to load "+pings.length+' ping boxes. Quit?')) {
		alert('Quitting!'); win.close()
	} else {
		$('#body').html([
			$('<p>').html("It's tag times! What were you doing RIGHT AT these times?"),
			$('<p>').html([Key("'"),' to repeat previous tags',$('<span id="ditto_o">').html([': ',$('<button id="ditto" class="inline tagstr">')])]),
			$('<ol class="tag_editor">').html(pings.map(function(v){return $('<li>').html([S('time').html(m(v.time*1000).format('HH:mm:ss')),Expando_input('tags_in_li','tags_in')])})),
			$('<button id="submit">').text('submit all'),
		])

		pings.forEach(function(v,i){if (v.tags) $($('.tags_in')[i]).text(v.tags)})

		var c_first = function(){return $('.tag_editor > *').first()}
		var c_set = function(v){if (v!==cur) {cur&&cur.removeClass('curr_line'); cur = v; cur.addClass('curr_line')}}
		var c_line = function(){return cur.is($('#submit'))? undefined : cur.find('.tags_in')}
		var c_next = function(){var t; if (cur.is($('#submit'))) c_set(c_first()); else c_set((t=cur.next()).length!==0? t : $('#submit')); c_focus(); return false}
		var c_prev = function(){var t; if (cur.is($('#submit'))) c_set($('.tag_editor > *').last()); else c_set((t=cur.prev()).length!==0? t : $('#submit')); c_focus(); return false}
		var c_focus = function(){if (cur.is($('#submit'))) cur.focus(); else cur.find('.tags_in').focus_end()}
		var cur; c_set(c_first())

		c_focus()
		$(window).on('click.qqq',function(e){c_focus()})
		$('.tags_in').on('click.qqq',function(e){e.stopPropagation(); c_set($(this).closest('li'))})

		//! we broke clicking
		//! ditto text should go away when you go down
		//! when to add afk to things?
		//! when adding to the top and bottom, current selection should try to stay in the same place
		//! resizing and/or moving the window flashes it white
		//! sufficiently faraway times should be longer!
		//! sufficiently nearby times could be shorter! dynamically so, even! yeah. dynamically.
		//! ditto should not do anything if there is no prev_ping
		//! ditto should pick the previous tags, not the prev_ping
		//! prev_ping needs to update dynamically
		//! i wanna see the blinky thing!
		//! arrow keys should *not* scroll the scrollbars

		$('.tags_in').on_key('↩',c_next)
		$('.tags_in, #submit').on_key('⇥',c_next)
		$('.tags_in, #submit').on_key('↓',c_next)
		$('.tags_in').on_key('↑',function(e){
			if (cur.is(c_first())) {if (prev_ping) {pings.unshift(prev_ping); prev_ping = undefined; fetch_up(regenerate)}}
			else c_prev()
			return false})
		$('#submit').on_key('↑',c_prev)
		if (prev_ping) {
			$('#ditto').text(prev_ping.tags)
			var ditto = function(){var t; if (t=c_line()) {t.text(tags_union(t.text(),prev_ping.tags)); c_next()}}
			$('#ditto').on('click.qqq',ditto)
			$('.tags_in').on_key('\'',function(e){e.preventDefault(); ditto()})
		} else {
			$('#ditto_o').hide()
		}
		$('#submit').on('click.qqq',function(e){e.stopPropagation(); return_and_close()})

		win.setResizable(true)
		var x = $('#body').width()+16
		var y = $('#body').height()+16
		win.setMaximumSize(x,y)
		win.setMinimumSize(x,20)
		win.resizeTo(x,y=Math.min(y,Math.round(x*1.5)))
		win.moveTo(Math.round((window.screen.width-x)/2),Math.round((window.screen.height-y)/2))
	}
	cb&&cb()}}

var beep = function(){if (shown) new Audio(global.fs(args.sound).realpath()).play()}

var return_and_close = function(canceled){
	done = true
	pings.forEach(function(v){v.tags = v.tags||''})
	if ($('.tags_in').length === pings.length) [pings,$('.tags_in').toArray().map(function(v){return $(v).text()})].zipmap(function(v,tags){v.tags = tags})
	else print('oh gosh!',$('.tags_in').length,pings.length)
	if (canceled) pings.forEach(function(v){v.tags = tags_union(v.tags,'canceled')})
	win.close(true)
	args.cb(null,pings)}

global.pub('ping_prompt',{
	init:function(args_){args = args_; build_window()},
	ping:function(ping){if (!done) {pings.push(ping); fetch_up(regenerate); beep(); return true}},
	show:function(cb){args.cb = cb; shown = true; fetch_up(function(){regenerate(function(){beep(); win.showf.in(0.2)})})},
	})

</script>